stevo@stone:/media/data/docker/openstreetmap-tile-server$ ./import_planet.sh
################################################################################
Benchmark openstreetmap-tile-server import
import file: /media/data/docker/openstreetmap-tile-server/volumes/download/planet-latest.osm.pbf
################################################################################
  dev-stevo                       307294b update postgresql.custom.conf and osm2psql -C Param for import of slim planet
  import_002                      e9236ae update Benchmark Results
* import_003                      fcc6168 Fix updating by moving to latest version of regional extract tool
  master                          fcc6168 Fix updating by moving to latest version of regional extract tool
  stevo-autovacuum                a02daac [behind 6] environment variable AUTOVACUUM added
  update                          a362c7d adaptations for update procedure
  remotes/Overv/master            fcc6168 Fix updating by moving to latest version of regional extract tool
  remotes/origin/HEAD             -> origin/master
  remotes/origin/dev-stevo        307294b update postgresql.custom.conf and osm2psql -C Param for import of slim planet
  remotes/origin/import_001       307294b update postgresql.custom.conf and osm2psql -C Param for import of slim planet
  remotes/origin/import_002       e162aa8 update for second import (with log file for benchmark)
  remotes/origin/import_003       fcc6168 Fix updating by moving to latest version of regional extract tool
  remotes/origin/issue2           4e5828e error correction wrong usage of environment variable inside script openstreetmap-tiles-update-expire
  remotes/origin/issue39          6a2143a error correction in shell script openstreetmap-tiles-update-expire
  remotes/origin/master           fcc6168 Fix updating by moving to latest version of regional extract tool
  remotes/origin/stevo-autovacuum 095c3ba Merge branch 'master' into stevo-autovacuum
  remotes/origin/update           a362c7d adaptations for update procedure

date=Mon 19 Aug 2019 07:08:01 AM CEST

cleanup data in psql data directory
openstreetmap-data-planet-latest
openstreetmap-data-planet-latest
cleanup data in psql data directory
openstreetmap-flat-planet-latest
openstreetmap-flat-planet-latest

docker run --rm -e AUTOVACUUM=off -e THREADS=16 -e NCACHE=3072 -e UPDATES=enabled --name openstreetmap-tile-server --publish 8001:80 -v /media/data/docker/openstreetmap-tile-server/volumes/log/dstat:/var/log/dstat -v /media/data/docker/openstreetmap-tile-server/volumes/download/planet-latest.osm.pbf:/data.osm.pbf -v openstreetmap-data-planet-latest:/var/lib/postgresql/10/main -v openstreetmap-rendered-tiles:/var/lib/mod_tile -v openstreetmap-flat-planet-latest:/flat openstreetmap-tile-server import

+ '[' 1 -ne 1 ']'
+ '[' import = import ']'
+ CreatePostgressqlConfig
+ cp /etc/postgresql/10/main/postgresql.custom.conf.tmpl /etc/postgresql/10/main/postgresql.custom.conf
+ dstat -m -c -r -s --output /var/log/dstat/dstat_import.cvs
+ sudo -u postgres echo 'autovacuum = off'
+ cat /etc/postgresql/10/main/postgresql.custom.conf
shared_buffers = 128MB
work_mem = 32MB
maintenance_work_mem = 256MB
min_wal_size = 1GB
max_wal_size = 2GB
temp_buffers = 32MB
wal_buffers = 1024kB

effective_io_concurrency = 500
checkpoint_timeout = 1h
checkpoint_completion_target = 0.9
random_page_cost = 1.1
max_connections = 250
wal_writer_delay = 500ms
commit_delay = 10000
track_activity_query_size = 16384

autovacuum = off
track_counts = off
fsync = off
synchronous_commit = off
autovacuum = off
+ service postgresql start
 * Starting PostgreSQL 10 database server
   ...done.
+ sudo -u postgres createuser renderer
+ sudo -u postgres createdb -E UTF8 -O renderer gis
+ sudo -u postgres psql -d gis -c 'CREATE EXTENSION postgis;'
CREATE EXTENSION
+ sudo -u postgres psql -d gis -c 'CREATE EXTENSION hstore;'
CREATE EXTENSION
+ sudo -u postgres psql -d gis -c 'ALTER TABLE geometry_columns OWNER TO renderer;'
ALTER TABLE
+ sudo -u postgres psql -d gis -c 'ALTER TABLE spatial_ref_sys OWNER TO renderer;'
ALTER TABLE
+ '[' '!' -f /data.osm.pbf ']'
+ osmium fileinfo /data.osm.pbf
+ osmium fileinfo /data.osm.pbf
+ grep osmosis_replication_timestamp=
+ cut -b35-44
++ cat /var/lib/mod_tile/replication_timestamp.txt
+ REPLICATION_TIMESTAMP=2019-08-11
+ sudo -u renderer openstreetmap-tiles-update-expire 2019-08-11
mkdir: cannot create directory '/var/lib/mod_tile/.osmosis': File exists
+ '[' -f /data.poly ']'
+ sudo chown renderer:renderer /flat
+ sudo -u renderer osm2pgsql -d gis --create --slim -G --hstore --flat-nodes /flat/osm.flat.cache --tag-transform-script /home/renderer/src/openstreetmap-carto/openstreetmap-carto.lua -C 3072 --number-processes 16 -S /home/renderer/src/openstreetmap-carto/openstreetmap-carto.style /data.osm.pbf
osm2pgsql version 0.96.0 (64 bit id space)

Allocating memory for dense node cache
Allocating dense node cache in one big chunk
Allocating memory for sparse node cache
Sharing dense sparse
Node-cache: cache=3072MB, maxblocks=49152*65536, allocation method=11
Mid: loading persistent node cache from /flat/osm.flat.cache
Mid: pgsql, cache=3072
Setting up table: planet_osm_nodes
Setting up table: planet_osm_ways
Setting up table: planet_osm_rels
Using lua based tag processing pipeline with script /home/renderer/src/openstreetmap-carto/openstreetmap-carto.lua
Using projection SRS 3857 (Spherical Mercator)
Setting up table: planet_osm_point
Setting up table: planet_osm_line
Setting up table: planet_osm_polygon
Setting up table: planet_osm_roads

Reading in file: /data.osm.pbf
Using PBF parser.
Processing: Node(5385098k 1743.3k/s) Way(596956k 22.85k/s) Relation(6984620 634.04/s)  parse time: 40229s
Node stats: total(5385098645), max(6701141252) in 3089s
Way stats: total(596956981), max(712733827) in 26124s
Relation stats: total(6985641), max(9908123) in 11016s
Sorting data and creating indexes for planet_osm_polygon
Sorting data and creating indexes for planet_osm_line
Sorting data and creating indexes for planet_osm_roads
Sorting data and creating indexes for planet_osm_point
Stopping table: planet_osm_nodes
Stopping table: planet_osm_rels
Stopping table: planet_osm_ways
Building index on table: planet_osm_rels
Building index on table: planet_osm_ways
Stopped table: planet_osm_nodes in 0s
Stopped table: planet_osm_rels in 1806s
Copying planet_osm_point to cluster by geometry finished
Creating geometry index on planet_osm_point
Copying planet_osm_roads to cluster by geometry finished
Creating geometry index on planet_osm_roads
Creating osm_id index on planet_osm_roads
Creating indexes on planet_osm_roads finished
All indexes on planet_osm_roads created in 5814s
Completed planet_osm_roads
Creating osm_id index on planet_osm_point
Creating indexes on planet_osm_point finished
All indexes on planet_osm_point created in 7307s
Completed planet_osm_point
Copying planet_osm_line to cluster by geometry finished
Creating geometry index on planet_osm_line
Creating osm_id index on planet_osm_line
Creating indexes on planet_osm_line finished
All indexes on planet_osm_line created in 21084s
Completed planet_osm_line
Copying planet_osm_polygon to cluster by geometry finished
Creating geometry index on planet_osm_polygon

Creating osm_id index on planet_osm_polygon
Creating indexes on planet_osm_polygon finished
All indexes on planet_osm_polygon created in 40799s
Completed planet_osm_polygon
Stopped table: planet_osm_ways in 74014s

Osm2pgsql took 114244s overall
node cache: stored: 378335693(7.03%), storage efficiency: 93.96% (dense blocks: 44049, sparse nodes: 20902193), hit rate: 6.92%
+ sudo -u postgres psql -d gis -f indexes.sql
